name: Build and Deploy LogiNeko on Windows

on:
  push:
    branches:
      - cicd # Hoáº·c nhÃ¡nh báº¡n muá»‘n dÃ¹ng

jobs:
  build-and-deploy-windows:
    # ðŸŽ¯ YÃªu cáº§u job nÃ y pháº£i cháº¡y trÃªn runner báº¡n vá»«a cÃ i Ä‘áº·t
    runs-on: self-hosted

    steps:
      # ðŸ§© 1. Láº¥y code tá»« branch
      - name: Checkout code
        uses: actions/checkout@v4

      # â˜• 2. CÃ i Java 21 (Temurin)
      - name: Set up JDK 21 and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          maven-version: '3.9.8' # <--- ThÃªm dÃ²ng nÃ y

      # âš™ï¸ 3. Build project báº±ng Maven
      - name: Build with Maven
        # Cháº¡y lá»‡nh Maven báº±ng PowerShell
        run: mvn clean package -DskipTests
        shell: powershell

      # ðŸ” 4. Táº¡o file .env tá»« secrets GitHub (cÃº phÃ¡p cho PowerShell)
      - name: Create .env file
        shell: pwsh
        run: |
          @"
          KEYCLOAK_CLIENT_SECRET=${{ secrets.KEYCLOAK_CLIENT_SECRET }}
          KEYCLOAK_URL=${{ secrets.KEYCLOAK_URL }}
          KEYCLOAK_URL_WEB=${{ secrets.KEYCLOAK_URL_WEB }}
          KEYCLOAK_CLIENT_ID=${{ secrets.KEYCLOAK_CLIENT_ID }}
          KEYCLOAK_REALM=${{ secrets.KEYCLOAK_REALM }}
          kafka_server=${{ secrets.KAFKA_SERVER }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          REDIRECT_URI=${{ secrets.REDIRECT_URI }}
          REDIRECT_URI_WEB=${{ secrets.REDIRECT_URI_WEB }}
          POSTGRES_PASSWORD_KEYCLOAK=${{ secrets.POSTGRES_PASSWORD_KEYCLOAK }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          PAYOS_CLIENT_ID=${{ secrets.PAYOS_CLIENT_ID }}
          PAYOS_API_KEY=${{ secrets.PAYOS_API_KEY }}
          PAYOS_CHECKSUM_KEY=${{ secrets.PAYOS_CHECKSUM_KEY }}
          PAYOS_BASE_URL=${{ secrets.PAYOS_BASE_URL }}
          PAYOS_SUCCESS_PAGE=${{ secrets.PAYOS_SUCCESS_PAGE }}
          PAYOS_FAILURE_PAGE=${{ secrets.PAYOS_FAILURE_PAGE }}
          "@ | Out-File -FilePath .env -Encoding utf8

      # ðŸš€ 5. Deploy trá»±c tiáº¿p báº±ng Docker Compose
      - name: Deploy with Docker Compose
        shell: pwsh
        run: |
          # Dá»«ng láº¡i náº¿u cÃ³ lá»—i xáº£y ra
          $ErrorActionPreference = "Stop"

          echo "ðŸš€ Starting deployment directly on Windows host..."
          
          # Di chuyá»ƒn vÃ o thÆ° má»¥c chá»©a code mÃ  runner Ä‘Ã£ checkout
          # ÄÃ¢y lÃ  nÆ¡i chá»©a file .jar, .env vÃ  docker-compose.yml cá»§a báº¡n
          cd "${{ github.workspace }}"
          
          echo "ðŸ“ Current directory:"
          ls
          
          # Äáº£m báº£o Docker Desktop Ä‘ang cháº¡y (bÆ°á»›c nÃ y báº¡n cáº§n tá»± Ä‘áº£m báº£o)
          echo "ðŸ›‘ Stopping existing containers..."
          docker compose down --timeout 30
          
          echo "ðŸ§¹ Cleaning up old images..."
          docker system prune -f
          
          echo "ðŸ—ï¸ Building and starting new containers..."
          docker compose up -d --build --force-recreate
          
          echo "â³ Waiting for containers to stabilize..."
          Start-Sleep -Seconds 30
          
          echo "ðŸ“Š Final container status:"
          docker compose ps
          
          echo "âœ… Deployment on Windows completed successfully!"